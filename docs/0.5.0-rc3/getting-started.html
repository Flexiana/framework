<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>How to make a Todo app using Xiana</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script><link rel="stylesheet" type="text/css" href="css/xiana.css" /></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name"></span> <span class="project-version"></span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="welcome.html"><div class="inner"><span>Xiana framework</span></div></a></li><li class="depth-1 "><a href="conventions.html"><div class="inner"><span>Conventions</span></div></a></li><li class="depth-1 "><a href="tutorials.html"><div class="inner"><span>Tutorials</span></div></a></li><li class="depth-1 "><a href="how-to.html"><div class="inner"><span>How to</span></div></a></li><li class="depth-1 "><a href="contribution.html"><div class="inner"><span>Contribution</span></div></a></li><li class="depth-1  current"><a href="getting-started.html"><div class="inner"><span>How to make a Todo app using Xiana</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>xiana</span></div></div></li><li class="depth-2 branch"><a href="xiana.coercion.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>coercion</span></div></a></li><li class="depth-2 branch"><a href="xiana.commons.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>commons</span></div></a></li><li class="depth-2 branch"><a href="xiana.config.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>config</span></div></a></li><li class="depth-2 branch"><a href="xiana.cookies.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>cookies</span></div></a></li><li class="depth-2"><a href="xiana.db.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>db</span></div></a></li><li class="depth-3"><a href="xiana.db.migrate.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>migrate</span></div></a></li><li class="depth-2 branch"><a href="xiana.handler.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>handler</span></div></a></li><li class="depth-2 branch"><a href="xiana.hash.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>hash</span></div></a></li><li class="depth-2"><a href="xiana.interceptor.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interceptor</span></div></a></li><li class="depth-3 branch"><a href="xiana.interceptor.error.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>error</span></div></a></li><li class="depth-3 branch"><a href="xiana.interceptor.muuntaja.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>muuntaja</span></div></a></li><li class="depth-3 branch"><a href="xiana.interceptor.queue.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>queue</span></div></a></li><li class="depth-3"><a href="xiana.interceptor.wrap.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>wrap</span></div></a></li><li class="depth-2 branch"><a href="xiana.mail.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>mail</span></div></a></li><li class="depth-2 branch"><a href="xiana.rbac.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>rbac</span></div></a></li><li class="depth-2"><a href="xiana.route.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>route</span></div></a></li><li class="depth-3"><a href="xiana.route.helpers.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>helpers</span></div></a></li><li class="depth-2 branch"><a href="xiana.scheduler.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>scheduler</span></div></a></li><li class="depth-2 branch"><a href="xiana.session.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>session</span></div></a></li><li class="depth-2 branch"><a href="xiana.sse.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sse</span></div></a></li><li class="depth-2 branch"><a href="xiana.state.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>state</span></div></a></li><li class="depth-2 branch"><a href="xiana.webserver.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>webserver</span></div></a></li><li class="depth-2"><a href="xiana.websockets.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>websockets</span></div></a></li><li class="depth-3"><a href="xiana.websockets.router-helpers.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>router-helpers</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><p><img src="resources/images/Xiana.png" width="242" /></p>
<h1><a href="#how-to-make-a-todo-app-using-xiana" id="how-to-make-a-todo-app-using-xiana"></a>How to make a Todo app using Xiana</h1>
<h2><a href="#requirements" id="requirements"></a>Requirements</h2>
<ul>
<li>docker</li>
<li>docker-compose</li>
</ul>
<h2><a href="#create-a-new-app" id="create-a-new-app"></a>Create a new app</h2>
<h3><a href="#1-use-xiana-template-to-create-project-scaffold" id="1-use-xiana-template-to-create-project-scaffold"></a>1. Use Xiana template to create project scaffold</h3>
<p>Run the following code in your terminal</p>
<pre><code class="language-bash">lein new xiana todo-app
</code></pre>
<p>This will create a directory <em>todo-app</em> containing project scaffold.</p>
<h3><a href="#2-satisfy-dependencies" id="2-satisfy-dependencies"></a>2. Satisfy dependencies</h3>
<p>Run the following command from the newly created project directory to fetch frontend dependencies</p>
<pre><code class="language-bash">lein shadow npm-deps
</code></pre>
<h3><a href="#3-run-dockerized-database" id="3-run-dockerized-database"></a>3. Run dockerized database</h3>
<p>You need to have docker and docker-compose installed on your machine for the following command to work. Run the following from the root directory of your project.</p>
<pre><code class="language-bash">docker-compose up -d
</code></pre>
<p>This should spin up a PostgreSQL database on port 5433. Name of the DB is <code>todo_app</code> You can verify that the database is running by connecting to it. Value of <code>username</code> and <code>password</code> is <em><code>postgres</code>.</em></p>
<pre><code class="language-bash">docker exec -it todo-app_db_1 psql -U postgres -d todo_app
</code></pre>
<p>which should open a PostgreSQL shell if successful.</p>
<h3><a href="#4-populate-database-with-data" id="4-populate-database-with-data"></a>4. Populate database with data</h3>
<p>On application start, the framework will look for database migrations located in the configured location. By default, this location is set to <em>resources/migrations</em> directory*.*</p>
<p>It is possible to create migrations by running from the project directory</p>
<pre><code class="language-bash">lein migrate create todos
</code></pre>
<p>This will create two migration files inside the <em>resources/migrations</em> directory. Both file names will be prefixed by the timestamp value of the file creation.</p>
<p>Put the following SQL code inside the <em>todos-up.sql</em> file</p>
<pre><code class="language-sql">CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
--;;
CREATE TABLE todos
(
    id uuid NOT NULL DEFAULT uuid_generate_v4() PRIMARY KEY,
    label varchar(2048) NOT NULL,
    done boolean NOT NULL DEFAULT false,
    created_at timestamptz NOT NULL DEFAULT now()
);

--;;

INSERT INTO todos (label) values ('example label from DB');
</code></pre>
<p>and this one into the <em>todos-down.sql</em> file.</p>
<pre><code class="language-sql">DROP TABLE todos;
</code></pre>
<h3><a href="#5-start-the-application" id="5-start-the-application"></a>5. Start the application</h3>
<ol>
<li>Run Clojure REPL and load contents of file <em>dev/user.clj</em> into it.</li>
<li>Execute function <em>start-dev-system</em></li>
<li>Your <strong>Todo App</strong> should now be running. You can verify it by visiting URL <em><a href="http://localhost:3000/re-frame">http://localhost:3000/re-frame</a></em> in your browser.</li>
</ol>
<h3><a href="#6-add-endpoint-to-backend-api" id="6-add-endpoint-to-backend-api"></a>6. Add endpoint to backend API</h3>
<p>Routes definition can be found in the <em>src/backend/todo_app/core.clj</em> file. Replace the routes definition with following code.</p>
<pre><code class="language-clojure">(def routes
  [["/api/todos" {:action #'fetch}]])
</code></pre>
<p>define a function to be called when the endpoint is hit.</p>
<pre><code class="language-clojure">(defn fetch
  [state]
  state)
</code></pre>
<p>Now you need to reload the changed files to REPL and restart the application by executing <em>start-dev-system</em> function once again. Now opening <a href="http://localhost:3000/api/todos">http://localhost:3000/api/todos</a> in your browser returns a blank page.</p>
<h3><a href="#7-hello-world" id="7-hello-world"></a>7. Hello World!</h3>
<p>Change the implementation of <em>fetch</em> function to display “Hello World!” every time our endpoint is hit.</p>
<pre><code class="language-clojure">(defn fetch
  [state]
  (assoc state :response {:status 200
                          :body   "Hello World!"}))
</code></pre>
<p>Reload the modified function and restart the application.</p>
<h3><a href="#8-return-contents-of-the-todos-table" id="8-return-contents-of-the-todos-table"></a>8. Return contents of the todos table</h3>
<p>Change the implementation of function <em>fetch</em> once again and create a new <em>view</em> function.</p>
<p>Function:</p>
<ul>
<li><em>fetch</em> - now contains SQL query and a reference to a newly created <em>view</em> function.</li>
<li><em>view</em> - describes a transformation of the data returned from the database to the form returned by server response.</li>
</ul>
<pre><code class="language-clojure">(defn view
  [{{db-data :db-data} :response-data :as state}]
  (assoc state :response {:status 200
                          :body   (mapv :todos/label db-data)}))
(defn fetch
  [state]
  (assoc state
    :view view
    :query {:select [:*] :from [:todos]}))
</code></pre>
<p>Again, reload the modified function and restart the application.</p>
<p>After running following curl command from your shell, live data from your database should appear on your screen.</p>
<pre><code class="language-clojure">curl http://localhost:3000/api/todos
</code></pre>
<h2><a href="#create-a-page-in-the-app-to-display-data-returned-by-the-endpoint" id="create-a-page-in-the-app-to-display-data-returned-by-the-endpoint"></a>Create a page in the app to display data returned by the endpoint</h2>
<h3><a href="#1-add-frontend-dependencies" id="1-add-frontend-dependencies"></a>1. Add frontend dependencies</h3>
<p>Add following dependencies into <em>project.clj</em> file.</p>
<pre><code class="language-clojure">(defproject
  ...
  :dependencies [
                 ...
                 [cljs-ajax "0.8.4"]
                 [day8.re-frame/http-fx "0.2.3"]
                 ...
                 ]
  ...
  )
</code></pre>
<h3><a href="#2-set-initial-value-of-re-frame-database" id="2-set-initial-value-of-re-frame-database"></a>2. Set initial value of re-frame database</h3>
<p>File <em>src/frontend/todo_app/db.cljs</em> contains initial value of re-frame databse. Inside of this file replace value of * default-db* to following:</p>
<pre><code class="language-clojure">(def default-db
  {:todos []})
</code></pre>
<h3><a href="#3-define-re-frame-events" id="3-define-re-frame-events"></a>3. Define re-frame events</h3>
<p>Replace contents of <em>src/frontend/todo_app/events.cljs</em> file with the following code:</p>
<pre><code class="language-clojure">(ns todo-app.events
  (:require
    [re-frame.core :as re-frame]
    [ajax.core :as ajax]
    [day8.re-frame.http-fx]
    [todo-app.db :as db]
    ))

(defn url [tail] (str "http://localhost:3000" tail))

(re-frame/reg-event-db
  ::initialize-db
  (fn [_ _]
    db/default-db))

(re-frame/reg-event-db
  ::add-todos-&gt;db
  (fn [db [_ response]]
    (assoc db :todos response)))

(re-frame/reg-event-db
  ::failure
  (fn [db _]
    (js/console.error "Something is wrong!")
    db))

(re-frame/reg-event-fx
  ::fetch-todos!
  (fn [_ [_]]
    (js/console.info "Fetching todos!")
    {:http-xhrio {:uri             (url "/api/todos")
                  :response-format (ajax/json-response-format {:keywords? true})
                  :format          (ajax/json-request-format)
                  :on-success      [::add-todos-&gt;db]
                  :on-failure      [::failure]}}))
</code></pre>
<h3><a href="#4-define-re-frame-subscription" id="4-define-re-frame-subscription"></a>4. Define re-frame subscription</h3>
<p>Replace contents of <em>src/frontend/todo_app/subs.cljs</em> file with the following code:</p>
<pre><code class="language-clojure">(ns todo-app.subs
  (:require
    [re-frame.core :as re-frame]))

(re-frame/reg-sub
  ::todos
  (fn [db]
    (:todos db)))
</code></pre>
<h3><a href="#5-define-page-view" id="5-define-page-view"></a>5. Define page view</h3>
<p>Replace contents of <em>src/frontend/todo_app/views.cljs</em> file with the following code:</p>
<pre><code class="language-clojure">(ns todo-app.views
  (:require
    [re-frame.core :as re-frame]
    [todo-app.events :as events]
    [todo-app.subs :as subs]))

(defn main-panel []
  (re-frame/dispatch [::events/fetch-todos!])
  (let [todos (re-frame/subscribe [::subs/todos])]
    [:div
     (map #(identity [:ul %])
          @todos)]))
</code></pre>
<h3><a href="#6-define-frontend-routes" id="6-define-frontend-routes"></a>6. Define frontend routes</h3>
<p>Update <em>routes</em> definition in file <em>src/backend/todo_app/core.clj</em> to following:</p>
<pre><code class="language-clojure">(def routes
  [["/todos" {:action #'re-frame/handle-index}]
   ["/assets/*" (ring/create-resource-handler {:path "/"})]
   ["/api" {}
    ["/todos" {:get {:action #'fetch}}]]])
</code></pre>
<h3><a href="#7-at-this-point-the-app-should-be-running" id="7-at-this-point-the-app-should-be-running"></a>7. At this point the app should be running</h3>
<p>Again, reload the modified code and restart the application. After opening <a href="http://localhost:3000/todos">http://localhost:3000/todos</a> in your browser, it returns a page containing the data from our database that looks like this:</p>
<p><img src="./resources/images/success.png" alt="success" /></p>
<h2><a href="#create-another-endpoint-to-add-a-new-entry-to-the-db" id="create-another-endpoint-to-add-a-new-entry-to-the-db"></a>Create another endpoint to add a new entry to the DB</h2>
<p>Left as an exercise for the reader.</p>
</div></div></div></body></html>