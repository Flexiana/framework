<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>3. Controller basic architecture</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script><link rel="stylesheet" type="text/css" href="css/xiana.css" /></head><body><div id="header"><div class="logo"><h3>Xiana logo here</h3></div><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Framework</span> <span class="project-version">0.3.0</span></span></a></h1></div><div class="sidebar primary"><div class="logo"><h3>Or Xiana Logo Here</h3></div><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="0001-record-architecture-decisions.html"><div class="inner"><span>1. Record architecture decisions</span></div></a></li><li class="depth-1 "><a href="0002-database-basic-architecture.html"><div class="inner"><span>2. Database basic architecture</span></div></a></li><li class="depth-1  current"><a href="0003-controller-architecture.html"><div class="inner"><span>3. Controller basic architecture</span></div></a></li><li class="depth-1 "><a href="intro.html"><div class="inner"><span>Introduction to framework</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>framework</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>acl</span></div></div></li><li class="depth-3"><a href="framework.acl.builder.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>builder</span></div></a></li><li class="depth-4 branch"><a href="framework.acl.builder.builder-functions.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>builder-functions</span></div></a></li><li class="depth-4 branch"><a href="framework.acl.builder.permissions.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>permissions</span></div></a></li><li class="depth-4"><a href="framework.acl.builder.roles.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>roles</span></div></a></li><li class="depth-3 branch"><a href="framework.acl.core.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-3"><a href="framework.acl.core-functions.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core-functions</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -207px;"><span class="top" style="height: 216px;"></span><span class="bottom"></span></span><span>app</span></div></div></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>view</span></div></div></li><li class="depth-4"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>css</span></div></div></li><li class="depth-5"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>tailwind</span></div></div></li><li class="depth-6 branch"><a href="framework.app.view.css.tailwind.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-6 branch"><a href="framework.app.view.css.tailwind.helpers.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>helpers</span></div></a></li><li class="depth-6 branch"><a href="framework.app.view.css.tailwind.preparers.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>preparers</span></div></a></li><li class="depth-6"><a href="framework.app.view.css.tailwind.resolvers.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>resolvers</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -238px;"><span class="top" style="height: 247px;"></span><span class="bottom"></span></span><span>auth</span></div></div></li><li class="depth-3"><a href="framework.auth.hash.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>hash</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>config</span></div></div></li><li class="depth-3"><a href="framework.config.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>db</span></div></div></li><li class="depth-3 branch"><a href="framework.db.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>impl</span></div></div></li><li class="depth-4"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>migrations</span></div></div></li><li class="depth-5 branch"><a href="framework.db.impl.migrations.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-5"><a href="framework.db.impl.migrations.migratus.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>migratus</span></div></a></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>migrations</span></div></div></li><li class="depth-4"><a href="framework.db.migrations.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-3 branch"><a href="framework.db.postgresql.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>postgresql</span></div></a></li><li class="depth-3"><a href="framework.db.sql.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sql</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -300px;"><span class="top" style="height: 309px;"></span><span class="bottom"></span></span><span>interceptor</span></div></div></li><li class="depth-3 branch"><a href="framework.interceptor.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-3 branch"><a href="framework.interceptor.muuntaja.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>muuntaja</span></div></a></li><li class="depth-3 branch"><a href="framework.interceptor.queue.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>queue</span></div></a></li><li class="depth-3"><a href="framework.interceptor.wrap.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>wrap</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>mail</span></div></div></li><li class="depth-3"><a href="framework.mail.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>rbac</span></div></div></li><li class="depth-3"><a href="framework.rbac.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>route</span></div></div></li><li class="depth-3 branch"><a href="framework.route.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-3"><a href="framework.route.helpers.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>helpers</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>session</span></div></div></li><li class="depth-3"><a href="framework.session.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>state</span></div></div></li><li class="depth-3"><a href="framework.state.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>webserver</span></div></div></li><li class="depth-3"><a href="framework.webserver.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree" style="top: -1478px;"><span class="top" style="height: 1487px;"></span><span class="bottom"></span></span><span>xiana</span></div></div></li><li class="depth-2 branch"><a href="xiana.commons.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>commons</span></div></a></li><li class="depth-2"><a href="xiana.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#3-controller-basic-architecture" name="3-controller-basic-architecture"></a>3. Controller basic architecture</h1>
<p>Date: 2021-01-27</p>
<h2><a href="#staus" name="staus"></a>Staus</h2>
<p>Proposed</p>
<h2><a href="#context" name="context"></a>Context</h2>
<ol>
  <li>The Controller is responsible for the lifecycle of the framework. It reflects the starting point and the means of controll of all the needed actions that the framework must do (load deps, render views, generate routes etc).</li>
  <li>The framework requires a simple and easy controll to the end user.</li>
  <li>In turn the interaction of the user with the controller should be simple understandable and destructured in smaller steps that would provide a better grain of detail in the controll of the application, validation and error management etc.</li>
  <li>The framework rational requires a functional approach but in a way that would be easy for new users and in a way that it would use user’s previous concept knowledge from similar frameworks in other programming languages.</li>
</ol>
<h2><a href="#decisions" name="decisions"></a>Decisions</h2>
<h3><a href="#1-controller-being" name="1-controller-being"></a>1. Controller being <code>monadic</code></h3>
<h4><a href="#explanation-" name="explanation-"></a>Explanation:</h4>
<p>The Controller would be a composition of different functions in steps as was created in the initial draft by Lukáš Rychtecký.</p>
<h4><a href="#why-" name="why-"></a>Why:</h4>
<p>This would provide the user with the ability to controll each step on it’s creation.</p>
<h5><a href="#example-" name="example-"></a>Example:</h5>
<pre><code class="clojure">(defn controller
  []
  (-&gt; {}
      (set-routes)
      (set-template)
      (set-response )
      (set-middlewares )
      (set-actions )
      (set-deps)
      (set-session))
  )
</code></pre>
<h3><a href="#2-controller-use-a-state-map-" name="2-controller-use-a-state-map-"></a>2. Controller use a State map.</h3>
<h4><a href="#explanation-" name="explanation-"></a>Explanation:</h4>
<p>The Controller would be ‘feeded’ with an initial state-map that the user would provide. The state-map would hold the data that would be needed to build the Controller. This approach is similar to the State monad but it would return only the result of the configuration and discard the initial state.</p>
<h4><a href="#why-" name="why-"></a>Why:</h4>
<p>This helps in two ways: 1. We can enforce a specific stucture in the definition of the state-map to the user. This would give a clearer understanding on the ‘ingredients’ that a controller would need to created to the user, as it would be a map which its keys would represent the different stages of the controller. 2. We would be able to validate the state-map and its data.</p>
<h5><a href="#example-" name="example-"></a>Example:</h5>
<h6><a href="#state-map-" name="state-map-"></a>state map:</h6>
<pre><code class="clojure">(def state {:http-request {:method :get
                           :url "/hi"
                           :request {:action :select :params {}}}
            :response {:headers (list {"Content-Type" "txt/html"}
                                 {"charset" "UTF-8"})
                       :body nil}
            :request-data {:model Foo
                           :template (comp temp)
                           :middlewares []}
            :session-data {}
            :deps {}})
</code></pre>
<h6><a href="#state-map-schema-" name="state-map-schema-"></a>state map schema:</h6>
<pre><code class="clojure">;; mali schema for the State Map
(def State-map
  [:map
   [:http-request [:map
                  [:method [:enum :get :post :put]]
                  [:url [:vector]]
                  [:request [:action [:enum :select :update :delet :insert]]]]]
   [:response [:map
               [:headers [:vector]]
               [:body [:or [:string] [:vector] [:nil]]]
               ]]
   [:request-data [:map
                   [:model ;;malli schema
                    [:vector]]
                   [:template ;; hiccup or static
                    [:or [:vector]
                     [:string]]]
                   [:middlewares ;; list of functions to used for the middleware
                    [:vector]]]]
   [:deps [:map]]
   [:session [:map]]])
</code></pre>
<h6><a href="#controller-with-state-map-" name="controller-with-state-map-"></a>controller with state-map:</h6>
<pre><code class="clojure">(defn controller
  [state-map]
  (-&gt; {}
      (set-routes state-map)
      (set-template state-map)
      (set-response state-map)
      (set-middlewares state-map)
      (set-actions state-map)
      (set-deps state-map)
      (set-session state-map))
  )
</code></pre>
<h3><a href="#using-a-metosin-reitit-wrapper" name="using-a-metosin-reitit-wrapper"></a>Using a metosin/reitit wrapper</h3>
<h4><a href="#explanation-" name="explanation-"></a>Explanation:</h4>
<p>The controller would be wraped in a thin reitit wrapper with initial approach.</p>
<h4><a href="#why-" name="why-"></a>Why:</h4>
<ol>
  <li>Elevates the use of reitit and its already implemented functionality and safeguards.</li>
  <li>
  <p>Availability to perform validation on map to gurantee the correct definition of each stage.</p>
  <h5><a href="#exapmle-" name="exapmle-"></a>Exapmle:</h5>
  <h6><a href="#controller-result-map" name="controller-result-map"></a>controller result map</h6></li>
</ol>
<pre><code class="clojure">{:route ["/hi" :get],
 :template #function[poc.core/temp],
 :response
 {:headers ({"Content-Type" "txt/html"} {"charset" "UTF-8"}), :body nil},
 :middlewares [],
 :actions {:action :select, :params {}},
 :deps {},
 :session nil}
</code></pre>
<h6><a href="#result-map-schema" name="result-map-schema"></a>result map schema</h6>
<pre><code class="clojure">;; internal schema of an instance of a state-map
(def instance-map
  [:map
   [:route [:vector]]
   [:respones [:map [:headers [:list]
                     :body [:or [:string] [:vector]]]]]
   [:template [:or [:string] [:vector]]]
   [:actions [:vector [:and [:enum :select :delete :update :insert] [:map]]]]
   [:deps [:map]]
   [:middlewares [:list]]
   [:session [:map]]])
;;
</code></pre>
<h6><a href="#controller-build-and-routes" name="controller-build-and-routes"></a>controller build and routes</h6>
<pre><code class="clojure">(defn build-controller
  [ctrl]
  )

(defn generate-routes
  [ctrl]
  (ring/ring-handler
   (ring/router
    ["/api"
     (:route ctrl)]
    {:data {:coercion reitit.coercion.spec/coercion
              :middleware [rrc/coerce-exceptions-middleware
                           rrc/coerce-request-middleware
                           rrc/coerce-response-middleware]}})))
</code></pre></div></div></div></body></html>