<p><img src="resources/images/Xiana.png" width="242"></p><h1 id="how&#95;to&#95;make&#95;a&#95;todo&#95;app&#95;using&#95;xiana">How to make a Todo app using Xiana</h1><h2 id="requirements">Requirements</h2><ul><li>docker</li><li>docker-compose</li></ul><h2 id="create&#95;a&#95;new&#95;app">Create a new app</h2><h3 id="1.&#95;use&#95;xiana&#95;template&#95;to&#95;create&#95;project&#95;scaffold">1. Use Xiana template to create project scaffold</h3><p>Run the following code in your terminal</p><pre><code class="bash">lein new xiana todo-app
</code></pre><p>This will create a directory <em>todo-app</em> containing project scaffold.</p><h3 id="2.&#95;satisfy&#95;dependencies">2. Satisfy dependencies</h3><p>Run the following command from the newly created project directory to fetch frontend dependencies</p><pre><code class="bash">lein shadow npm-deps
</code></pre><h3 id="3.&#95;run&#95;dockerized&#95;database">3. Run dockerized database</h3><p>You need to have docker and docker-compose installed on your machine for the following command to work. Run the following from the root directory of your project.</p><pre><code class="bash">docker-compose up -d
</code></pre><p>This should spin up a PostgreSQL database on port 5433. Name of the DB is <code>todo&#95;app</code> You can verify that the database is running by connecting to it. Value of <code>username</code> and <code>password</code> is <em><code>postgres</code>.</em></p><pre><code class="bash">docker exec -it todo-app&#95;db&#95;1 psql -U postgres -d todo&#95;app
</code></pre><p>which should open a PostgreSQL shell if successful.</p><h3 id="4.&#95;populate&#95;database&#95;with&#95;data">4. Populate database with data</h3><p>On application start, the framework will look for database migrations located in the configured location. By default, this location is set to <em>resources/migrations</em> directory<em>.</em></p><p>It is possible to create migrations by running from the project directory</p><pre><code class="bash">lein migrate create todos
</code></pre><p>This will create two migration files inside the <em>resources/migrations</em> directory. Both file names will be prefixed by the timestamp value of the file creation.</p><p>Put the following SQL code inside the <em>todos-up.sql</em> file</p><pre><code class="sql">CREATE EXTENSION IF NOT EXISTS &quot;uuid-ossp&quot;;
--;;
CREATE TABLE todos
&#40;
    id uuid NOT NULL DEFAULT uuid&#95;generate&#95;v4&#40;&#41; PRIMARY KEY,
    label varchar&#40;2048&#41; NOT NULL,
    done boolean NOT NULL DEFAULT false,
    created&#95;at timestamptz NOT NULL DEFAULT now&#40;&#41;
&#41;;

--;;

INSERT INTO todos &#40;label&#41; values &#40;'example label from DB'&#41;;
</code></pre><p>and this one into the <em>todos-down.sql</em> file.</p><pre><code class="sql">DROP TABLE todos;
</code></pre><h3 id="5.&#95;start&#95;the&#95;application">5. Start the application</h3><ol><li>Run Clojure REPL and load contents of file <em>dev/user.clj</em> into it.</li><li>Execute function <em>start-dev-system</em></li><li>Your <strong>Todo App</strong> should now be running. You can verify it by visiting URL   <em><a href='http://localhost:3000/re-frame'>http://localhost:3000/re-frame</a></em> in your browser.</li></ol><h3 id="6.&#95;add&#95;endpoint&#95;to&#95;backend&#95;api">6. Add endpoint to backend API</h3><p>Routes definition can be found in the <em>src/backend/todo_app/core.clj</em> file. Replace the routes definition with following code.</p><pre><code class="clojure">&#40;def routes
  &#91;&#91;&quot;/api/todos&quot; {:action #'fetch}&#93;&#93;&#41;
</code></pre><p>define a function to be called when the endpoint is hit.</p><pre><code class="clojure">&#40;defn fetch
  &#91;state&#93;
  state&#41;
</code></pre><p>Now you need to reload the changed files to REPL and restart the application by executing <em>start-dev-system</em> function once again. Now opening <a href='http://localhost:3000/api/todos'>http://localhost:3000/api/todos</a> in your browser returns a blank page.</p><h3 id="7.&#95;hello&#95;world!">7. Hello World!</h3><p>Change the implementation of <em>fetch</em> function to display "Hello World!" every time our endpoint is hit.</p><pre><code class="clojure">&#40;defn fetch
  &#91;state&#93;
  &#40;assoc state :response {:status 200
                          :body   &quot;Hello World!&quot;}&#41;&#41;
</code></pre><p>Reload the modified function and restart the application.</p><h3 id="8.&#95;return&#95;contents&#95;of&#95;the&#95;todos&#95;table">8. Return contents of the todos table</h3><p>Change the implementation of function <em>fetch</em> once again and create a new <em>view</em> function.</p><p>Function:</p><ul><li><em>fetch</em> - now contains SQL query and a reference to a newly created <em>view</em> function.</li><li><em>view</em> - describes a transformation of the data returned from the database to the form returned by server response.<pre><code class="clojure">&#40;defn view
  &#91;{{db-data :db-data} :response-data :as state}&#93;
  &#40;assoc state :response {:status 200
                          :body   &#40;mapv :todos/label db-data&#41;}&#41;&#41;
&#40;defn fetch
  &#91;state&#93;
  &#40;assoc state
    :view view
    :query {:select &#91;:&#42;&#93; :from &#91;:todos&#93;}&#41;&#41;
</code></pre></li></ul><p>Again, reload the modified function and restart the application.</p><p>After running following curl command from your shell, live data from your database should appear on your screen.</p><pre><code class="clojure">curl http://localhost:3000/api/todos
</code></pre><h2 id="create&#95;a&#95;page&#95;in&#95;the&#95;app&#95;to&#95;display&#95;data&#95;returned&#95;by&#95;the&#95;endpoint">Create a page in the app to display data returned by the endpoint</h2><h3 id="1.&#95;add&#95;frontend&#95;dependencies">1. Add frontend dependencies</h3><p>Add following dependencies into <em>project.clj</em> file.</p><pre><code class="clojure">&#40;defproject
  ...
  :dependencies &#91;
                 ...
                 &#91;cljs-ajax &quot;0.8.4&quot;&#93;
                 &#91;day8.re-frame/http-fx &quot;0.2.3&quot;&#93;
                 ...
                 &#93;
  ...
  &#41;
</code></pre><h3 id="2.&#95;set&#95;initial&#95;value&#95;of&#95;re-frame&#95;database">2. Set initial value of re-frame database</h3><p>File <em>src/frontend/todo_app/db.cljs</em> contains initial value of re-frame databse. Inside of this file replace value of * default-db* to following:</p><pre><code class="clojure">&#40;def default-db
  {:todos &#91;&#93;}&#41;
</code></pre><h3 id="3.&#95;define&#95;re-frame&#95;events">3. Define re-frame events</h3><p>Replace contents of <em>src/frontend/todo_app/events.cljs</em> file with the following code:</p><pre><code class="clojure">&#40;ns todo-app.events
  &#40;:require
    &#91;re-frame.core :as re-frame&#93;
    &#91;ajax.core :as ajax&#93;
    &#91;day8.re-frame.http-fx&#93;
    &#91;todo-app.db :as db&#93;
    &#41;&#41;

&#40;defn url &#91;tail&#93; &#40;str &quot;http://localhost:3000&quot; tail&#41;&#41;

&#40;re-frame/reg-event-db
  ::initialize-db
  &#40;fn &#91;&#95; &#95;&#93;
    db/default-db&#41;&#41;

&#40;re-frame/reg-event-db
  ::add-todos-&gt;db
  &#40;fn &#91;db &#91;&#95; response&#93;&#93;
    &#40;assoc db :todos response&#41;&#41;&#41;

&#40;re-frame/reg-event-db
  ::failure
  &#40;fn &#91;db &#95;&#93;
    &#40;js/console.error &quot;Something is wrong!&quot;&#41;
    db&#41;&#41;

&#40;re-frame/reg-event-fx
  ::fetch-todos!
  &#40;fn &#91;&#95; &#91;&#95;&#93;&#93;
    &#40;js/console.info &quot;Fetching todos!&quot;&#41;
    {:http-xhrio {:uri             &#40;url &quot;/api/todos&quot;&#41;
                  :response-format &#40;ajax/json-response-format {:keywords? true}&#41;
                  :format          &#40;ajax/json-request-format&#41;
                  :on-success      &#91;::add-todos-&gt;db&#93;
                  :on-failure      &#91;::failure&#93;}}&#41;&#41;
</code></pre><h3 id="4.&#95;define&#95;re-frame&#95;subscription">4. Define re-frame subscription</h3><p>Replace contents of <em>src/frontend/todo_app/subs.cljs</em> file with the following code:</p><pre><code class="clojure">&#40;ns todo-app.subs
  &#40;:require
    &#91;re-frame.core :as re-frame&#93;&#41;&#41;

&#40;re-frame/reg-sub
  ::todos
  &#40;fn &#91;db&#93;
    &#40;:todos db&#41;&#41;&#41;
</code></pre><h3 id="5.&#95;define&#95;page&#95;view">5. Define page view</h3><p>Replace contents of <em>src/frontend/todo_app/views.cljs</em> file with the following code:</p><pre><code class="clojure">&#40;ns todo-app.views
  &#40;:require
    &#91;re-frame.core :as re-frame&#93;
    &#91;todo-app.events :as events&#93;
    &#91;todo-app.subs :as subs&#93;&#41;&#41;

&#40;defn main-panel &#91;&#93;
  &#40;re-frame/dispatch &#91;::events/fetch-todos!&#93;&#41;
  &#40;let &#91;todos &#40;re-frame/subscribe &#91;::subs/todos&#93;&#41;&#93;
    &#91;:div
     &#40;map #&#40;identity &#91;:ul %&#93;&#41;
          @todos&#41;&#93;&#41;&#41;
</code></pre><h3 id="6.&#95;define&#95;frontend&#95;routes">6. Define frontend routes</h3><p>Update <em>routes</em> definition in file <em>src/backend/todo_app/core.clj</em> to following:</p><pre><code class="clojure">&#40;def routes
  &#91;&#91;&quot;/todos&quot; {:action #'re-frame/handle-index}&#93;
   &#91;&quot;/assets/&#42;&quot; &#40;ring/create-resource-handler {:path &quot;/&quot;}&#41;&#93;
   &#91;&quot;/api&quot; {}
    &#91;&quot;/todos&quot; {:get {:action #'fetch}}&#93;&#93;&#93;&#41;
</code></pre><h3 id="7.&#95;at&#95;this&#95;point&#95;the&#95;app&#95;should&#95;be&#95;running">7. At this point the app should be running</h3><p>Again, reload the modified code and restart the application. After opening <a href='http://localhost:3000/todos'>http://localhost:3000/todos</a> in your browser, it returns a page containing the data from our database that looks like this:</p><p><img src="./resources/images/success.png" alt="success" /></p><h2 id="create&#95;another&#95;endpoint&#95;to&#95;add&#95;a&#95;new&#95;entry&#95;to&#95;the&#95;db">Create another endpoint to add a new entry to the DB</h2><p>Left as an exercise for the reader.</p>